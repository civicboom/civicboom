from civicboom.tests import *

from civicboom.lib.communication.email_log import getLastEmail, getNumEmails

import re



class TestSignup(TestController):

    #---------------------------------------------------------------------------
    # Signup
    #---------------------------------------------------------------------------
    def test_signup(self):
        """
        request signup email
        follow link in email
        complete signup process
        logout
        login
        """
        self.log_out()
        
        
        # Request new user email for user that already exisits - reject
        response = self.app.post(
            url(controller='register', action='email'),
            params={
                'username': u'unittest',
            },
            status=400,
        )
        
        response = self.app.post(
            url(controller='register', action='email'),
            params={
                'username': u'unittest2',
                'email'   : u'bob@bobcorp.com'
            },
            status=400,
        )
        
        num_emails = getNumEmails()
        
        # Request new user email for new user
        response = self.app.post(
            url(controller='register', action='email'),
            params={
                'username': u'test_signup',
                'email'   : u'test@moose.com',
            },
        )
        
        # Get email generated by last event
        assert getNumEmails() == num_emails + 1
        email_response = getLastEmail()
        assert email_response.content_text
        
        # Check for link in email
        link = str(re.search(r'https?://(?:.*?)(/.*?)[\'"\s]', email_response.content_text+' ').group(1))
        assert 'hash' in link
        
        # follow email link
        response = self.app.get(link)
        assert 'password' in response
        assert 'dob'      in response
        assert 'terms'    in response
        
        # Fail validation
        response = self.app.post(
            link,
            params={
                'password'        : u'password',
                'password_confirm': u'password2',
                'dob'             : u'1/1/1980',
                'terms'           : u'checked'
            },
            status=400
        )
        
        response = self.app.post(
            link,
            params={
                'password'        : u'password',
                'password_confirm': u'password',
                'dob'             : u'1/1/2009',
                'terms'           : u'checked'
            },
            status=400
        )
        
        response = self.app.post(
            link,
            params={
                'password'        : u'password',
                'password_confirm': u'password',
                'dob'             : u'1/1/1980',
            },
            status=400
        )
        
        num_emails = getNumEmails()
        response = self.app.post(
            link,
            params={
                'password'        : u'password',
                'password_confirm': u'password',
                'dob'             : u'1/1/1980',
                'terms'           : u'checked'
            },
        )
        assert getNumEmails() == num_emails + 1
        #email_response = getLastEmail()
        #assert 'civicboom' in email_response.content_text
        
        self.log_in_as('test_signup', 'password')