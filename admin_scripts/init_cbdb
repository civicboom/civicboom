#!/bin/bash
if [ `whoami` != "postgres" ] ; then
	exec sudo -u postgres $0 $*
fi

export PGOPTIONS='--client-min-messages=warning'


##############################################################################
# clear

echo "Removing old data"
echo "DROP OWNED BY civicboom CASCADE" | psql -q
dropdb civicboom     # civicboom doesn't completely own these databases,
dropdb civicboom_log # why was this not here? :S
dropuser civicboom


##############################################################################
# user

echo "Creating civicboom user"
if [ "$PGPASSWORD" == "" ] ; then export PGPASSWORD=civicboom ; fi
echo "create user civicboom with password '$PGPASSWORD';" | psql -q


##############################################################################
# civicboom

echo "Creating civicboom database"
createdb -E utf8 -O civicboom civicboom

echo "  Loading PostGIS extras"
psql -q -d civicboom -f /usr/share/postgresql/9.0/contrib/postgis-1.5/postgis.sql
psql -q -d civicboom -f /usr/share/postgresql/9.0/contrib/postgis-1.5/spatial_ref_sys.sql

echo "  Granting extra permissions"
echo "grant all on spatial_ref_sys to civicboom;"  | psql -q -d civicboom
echo "grant all on geometry_columns to civicboom;" | psql -q -d civicboom


##############################################################################
# civicboom_log

echo "Creating civicboom_log database"
createdb -E utf8 -O civicboom civicboom_log
echo "
CREATE TABLE events(
	id UUID PRIMARY KEY NOT NULL,
	node VARCHAR(64) NOT NULL,
	date_sent TIMESTAMP NOT NULL DEFAULT now(),
	module VARCHAR(250) NOT NULL,
	line_num INTEGER NOT NULL,
	username VARCHAR(64) NOT NULL,
	persona VARCHAR(64) NOT NULL,
	url TEXT NOT NULL,
	address INET NOT NULL,
	priority INT NOT NULL,
	message TEXT NOT NULL
);
CREATE INDEX events__date_sent ON events(date_sent);
CREATE INDEX events__module ON events(module);
CREATE INDEX events__username ON events(username);
CREATE INDEX events__priority ON events(priority);
" | psql -U civicboom -d civicboom_log -h localhost >/dev/null

exit 0
