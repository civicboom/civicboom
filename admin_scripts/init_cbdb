#!/bin/bash
if [ `whoami` != "postgres" ] ; then
	exec sudo -u postgres $0 $*
fi

export PGOPTIONS='--client-min-messages=warning'


##############################################################################
# clear

echo "Removing old data"
dropdb civicboom_log
dropdb civicboom_gis
#dropdb civicboom_ses sessions now stored in memcachedb
dropdb civicboom
dropuser civicboom


##############################################################################
# user

echo "Creating civicboom user"
export PGPASSWORD=civicboom
echo "create user civicboom with password '$PGPASSWORD';" | psql -q


##############################################################################
# civicboom

echo "Creating civicboom database"
createdb -E utf8 -O civicboom civicboom

echo "  Loading PostGIS extras"
psql -q -d civicboom -f /usr/share/postgresql/9.0/contrib/postgis-1.5/postgis.sql
psql -q -d civicboom -f /usr/share/postgresql/9.0/contrib/postgis-1.5/spatial_ref_sys.sql

echo "  Granting extra permissions"
echo "grant all on spatial_ref_sys to civicboom;"  | psql -q -d civicboom
echo "grant all on geometry_columns to civicboom;" | psql -q -d civicboom


##############################################################################
# civicboom_gis

echo "Creating civicboom_gis database"
createdb -E utf8 -O civicboom civicboom_gis

echo "  Loading PostGIS extras"
psql -q -d civicboom_gis -f /usr/share/postgresql/9.0/contrib/postgis-1.5/postgis.sql
psql -q -d civicboom_gis -f /usr/share/postgresql/9.0/contrib/postgis-1.5/spatial_ref_sys.sql

echo "  Granting extra permissions"
echo "grant all on spatial_ref_sys to civicboom;"  | psql -q -d civicboom_gis
echo "grant all on geometry_columns to civicboom;" | psql -q -d civicboom_gis

PLACES="`dirname $0`/*.osm.bz2"
if [ -f $PLACES ] ; then
	echo "  Found $PLACES, populating location tables"
	osm2pgsql \
		--database civicboom_gis --host localhost \
		--username civicboom \
		--latlong --prefix osm \
		$PLACES
else
	echo "  Can't find $PLACES, creating blank tables"
	echo "<?xml version='1.0' encoding='UTF-8'?>
<osm version=\"0.6\" generator=\"Osmosis 0.37-SNAPSHOT\">
  <bound box=\"50.85861,0.03365,51.48229,1.60489\" origin=\"0.37-SNAPSHOT\"/>
</osm>" > /tmp/min.osm
	osm2pgsql \
		--database civicboom_gis --host localhost \
		--username civicboom \
		--latlong --prefix osm \
		/tmp/min.osm 2>/dev/null
	rm -f /tmp/min.osm
fi


##############################################################################
# civicboom_log

echo "Creating civicboom_log database"
createdb -E utf8 -O civicboom civicboom_log
echo "
CREATE TABLE events(
	id SERIAL PRIMARY KEY NOT NULL,
	date_sent TIMESTAMP NOT NULL DEFAULT now(),
	module VARCHAR(250) NOT NULL,
	line_num INTEGER NOT NULL,
	username VARCHAR(64) NOT NULL,
	persona VARCHAR(64) NOT NULL,
	url TEXT NOT NULL,
	address INET NOT NULL,
	priority INT NOT NULL,
	message TEXT NOT NULL
);
CREATE INDEX events__date_sent ON events(date_sent);
CREATE INDEX events__module ON events(module);
CREATE INDEX events__username ON events(username);
CREATE INDEX events__priority ON events(priority);
" | psql -U civicboom -d civicboom_log -h localhost >/dev/null

##############################################################################
# civicboom_ses

# sessions now stored in memcachedb
#echo "Creating civicboom_ses database"
#createdb -E utf8 -O civicboom civicboom_ses

exit 0
